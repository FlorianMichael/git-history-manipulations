#!/usr/bin/env bash
set -euo pipefail

print_help() {
  cat <<EOF
Rewrite all commits from a specific old email to a new name and email.

Usage:
  git rewrite-author --old-email OLD_EMAIL --new-name "New Name" --new-email NEW_EMAIL [--dry-run|--no-dry-run] [--force]

Positional fallback (deprecated):
  git rewrite-author OLD_EMAIL "New Name" NEW_EMAIL

Options:
  --old-email EMAIL      Old author/committer email to replace
  --new-name NAME        New author/committer name
  --new-email EMAIL      New author/committer email
  -n, --dry-run          Show what would be executed without changing history (default)
      --no-dry-run       Actually rewrite history
  -f, --force            Skip clean working tree check
  -h, --help             Show this help

This command rewrites Git history. You may need to force-push afterwards.
EOF
}

die() {
  echo "git-rewrite-author: $*" >&2
  exit 1
}

require_clean_worktree() {
  if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    if ! git diff --quiet || ! git diff --cached --quiet; then
      die "Working tree is not clean. Commit or stash your changes, or use --force."
    fi
  else
    die "Not inside a Git repository."
  fi
}

OLD_EMAIL=""
NEW_NAME=""
NEW_EMAIL=""
DRY_RUN=1
FORCE=0

if [ "$#" -eq 0 ]; then
  print_help
  exit 1
fi

while [ "$#" -gt 0 ]; do
  case "$1" in
    --old-email)
      OLD_EMAIL=${2-}; shift 2 || die "Missing value for --old-email" ;;
    --new-name)
      NEW_NAME=${2-}; shift 2 || die "Missing value for --new-name" ;;
    --new-email)
      NEW_EMAIL=${2-}; shift 2 || die "Missing value for --new-email" ;;
    -n|--dry-run)
      DRY_RUN=1; shift ;;
    --no-dry-run)
      DRY_RUN=0; shift ;;
    -f|--force)
      FORCE=1; shift ;;
    -h|--help)
      print_help; exit 0 ;;
    --)
      shift; break ;;
    -*)
      die "Unknown option: $1" ;;
    *)
      # Fallback to positional arguments
      if [ -z "$OLD_EMAIL" ]; then
        OLD_EMAIL="$1"
      elif [ -z "$NEW_NAME" ]; then
        NEW_NAME="$1"
      elif [ -z "$NEW_EMAIL" ]; then
        NEW_EMAIL="$1"
      else
        die "Unexpected positional argument: $1"
      fi
      shift ;;
  esac
done

[ -z "$OLD_EMAIL" ] && die "Missing --old-email or positional OLD_EMAIL"
[ -z "$NEW_NAME" ] && die "Missing --new-name or positional NEW_NAME"
[ -z "$NEW_EMAIL" ] && die "Missing --new-email or positional NEW_EMAIL"

if [ "$FORCE" -ne 1 ]; then
  require_clean_worktree
fi

FILTER_SCRIPT="if [ \"\${GIT_AUTHOR_EMAIL-}\" = \"$OLD_EMAIL\" ]; then
    export GIT_AUTHOR_NAME=\"$NEW_NAME\";
    export GIT_AUTHOR_EMAIL=\"$NEW_EMAIL\";
fi
if [ \"\${GIT_COMMITTER_EMAIL-}\" = \"$OLD_EMAIL\" ]; then
    export GIT_COMMITTER_NAME=\"$NEW_NAME\";
    export GIT_COMMITTER_EMAIL=\"$NEW_EMAIL\";
fi"

CMD="git filter-branch -f --env-filter '$FILTER_SCRIPT' --tag-name-filter cat -- --all"

echo "About to run:"
echo "  $CMD"
echo

if [ "$DRY_RUN" -eq 1 ]; then
  echo "Dry-run mode: not rewriting history. Use --no-dry-run to actually run."
  exit 0
fi

read -r -p "This will rewrite Git history. Continue? [y/N] " ans
case "${ans:-N}" in
  y|Y) ;;
  *)
    echo "Aborted." >&2
    exit 1
    ;;
esac

eval "$CMD"
